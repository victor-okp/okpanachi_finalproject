
---
title: "final_project.qmd"
author: "Victor Okpanachi"
format: html
editor: visual
---

title: "final_project.qmd" author: "Victor Okpanachi" format: html editor: visual ---


## Assessment of Microbial Water Quality in Dar es Salaam, Tanzania



Quarto enables you to weave together content and executable code into a finished document. To learn more about Quarto see <https://quarto.org>.
.
When you click the **Render** button a document will be generated that includes both content and the output of embedded code. You can embed code like this:
>>>>>>> 9dbb2ecf6e706564792bcc77536ecf75525f40eb

```{r}
# This data is a microbial water quality data collected in Dar es Salaam, Tanzania. It was collected last summer and the aim was to assess the level of microbial water quality from different water sources in three districts of Dar es Salaam bytesting for the presence of coliforms and E.coli which serves as an indicator for fecal contamination in water sources. 
```

You can add options to executable code like this

```{r}
# My data-loading step demonstrates key skills from Week 2 (data import and vectors) and Week 3 (tidyverse basics). I use read_csv() to import the raw water-quality dataset into R and load the necessary tidyverse packages to prepare for further cleaning and analysis.

library(tidyverse)

water_raw <- read_csv("data_raw/water_tz_full.csv")
View(water_raw)

```

The `echo: false` option disables the printing of code (only output is displayed).

```{r}
# This data-cleaning step demonstrates key skills from Week 3 (tidyverse basics), Week 6 (tidy data), and Week 7 (solving bigger problems). I use filter(), mutate(), and piping to create log-transformed microbial variables.

# Relevant raw columns before cleaning
water_raw %>%
  select(coliform_mpn_100mL, e_coli_mpn_100mL) %>%
  slice(1:10)   

# Cleaning step

water_clean <- water_raw |>
  filter(!is.na(coliform_mpn_100mL)) |>   
  mutate(
    log_coliform = log10(coliform_mpn_100mL + 1),
    log_ecoli    = log10(e_coli_mpn_100mL + 1)
  )

# Displaying the same columns AFTER cleaning to highlight changes
water_clean %>%
  select(coliform_mpn_100mL, e_coli_mpn_100mL,
         log_coliform, log_ecoli) %>%
  slice(1:10)

# To illustrate how the data were transformed, I display the original microbiological concentration columns (coliform_mpn_100mL, e_coli_mpn_100mL) alongside the newly created log-transformed variables (log_coliform, log_ecoli). This allows for visual comparison of the raw and processed values.
```


```{r}
# I Calculated summary statistics for mean coliform and E. coli concentrations across districts and water sources using tidyverse grouping and summarization. In the summary statistics, key concepts are from Week 3 (tidyverse basics), Week 4 (grouping data), and Week 7 (solving bigger problems). I use group_by() and summary() within a tidyverse pipeline to calculate mean coliform and E. coli concentrations across districts and water sources.

summary_microbes <- water_clean |>
  group_by(districts, water_source) |>
  summarise(
    mean_coliform = mean(coliform_mpn_100mL, na.rm = TRUE),
    mean_ecoli    = mean(e_coli_mpn_100mL, na.rm = TRUE),
    n = n(),
    .groups = "drop"
  )

# Displaying the summary table directly in the document
knitr::kable(
  summary_microbes,
  caption = "Mean Coliform and E. coli Concentrations by District and Water Source"
)

```

```{r}
# I demostrated key skills from Week 8 (reproducible workflows and project structure) by using an RStudio Project with subdirectories such as data_raw, data_clean, and outputs. I read data and save results using relative file paths (e.g., "data_raw/water_tz_full.csv" and "outputs/..."), and I scripted all data cleaning, analysis, and visualization in a Quarto document.

# I used boxplots to visualize microbial contamination patterns across districts and water sources, using concepts from Week 5 (data visualization), Week 3 (tidyverse basics), and Week 6 (tidy data principles). I used ggplot(), geom_boxplot(), log-scaled axes, and customized labels/themes to create clear visual summaries of coliform and E. coli contamination across districts and water sources.

# coliform by water source : This boxplot uses log-scaled coliform counts to compare contamination levels across water sources, and highlights variability and outliers in each category. I Use ggsave() to export the E. coli by district ggplot as a publication-quality image

ggplot(water_clean, aes(x = water_source, y = coliform_mpn_100mL)) +
  geom_boxplot(fill = "steelblue") +
  scale_y_log10() +
  labs(
    title = "Coliform Contamination by Water Source",
    x = "Water Source",
    y = "Coliform MPN/100 mL (log scale)"
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
ggsave(
  "outputs/coliform_by_water_source.png",
  width = 8, height = 5, dpi = 300
)

# coliform by Districts: This plot shows how coliform contamination varies across districts and allows visual comparison of central tendency, spread, and outliers. I Use ggsave() to export the E. coli by district ggplot as a publication-quality image

ggplot(water_clean, aes(x = districts, y = coliform_mpn_100mL)) +
  geom_boxplot(fill = "skyblue") +
  scale_y_log10() +
  labs(title = "Coliform Contamination by District",
       y = "Coliform MPN/100 mL (log scale)",
       x = "District")
ggsave(
  "outputs/coliform_by_district.png",
  width = 8, height = 5, dpi = 300
)

# E.coli by water source: This boxplot displays E. coli levels across different water sources, using a log scale to make skewed microbial data easier to interpret. I Use ggsave() to export the E. coli by district ggplot as a publication-quality image

ggplot(water_clean, aes(x = water_source, y = e_coli_mpn_100mL)) +
  geom_boxplot(fill = "tomato") +
  scale_y_log10() +
  labs(title = "E. coli Levels by Water Source",
       y = "E. coli MPN/100 mL (log scale)",
       x = "Water Source") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
ggsave(
  "outputs/ecoli_by_water_source.png",
  width = 8, height = 5, dpi = 300
)

# E.coli by Districts: This graph visualizes E. coli contamination differences across districts, highlighting variation in microbial levels and identifying potential outliers. I Use ggsave() to export the E. coli by district ggplot as a publication-quality image

ggplot(water_clean, aes(x = districts, y = e_coli_mpn_100mL)) +
  geom_boxplot(fill = "orange") +
  scale_y_log10() +
  labs(
    title = "E. coli Contamination by District",
    x = "District",
    y = "E. coli MPN/100 mL (log scale)"
  )

ggsave(
  "outputs/ecoli_by_district.png",
  width = 8, height = 5, dpi = 300
)


```

```{r}
# In this section, I demonstrated spatial analysis techniques introduced in Week 9: Spatial Data, where we learned how to work with vector-based geographic data using the terra package. 

# These packages provide tools for spatial analysis (terra), downloading administrative boundary datasets (geodata), and generating color gradients (viridis).

# install.packages("terra")
# install.packages("geodata")
# install.packages("viridis")

# Loading libraries needed for spatial data manipulation and visualization.
library(terra)
library(geodata)
library(viridis)
library(dplyr)
library(ggplot2)

# Created a log-transformed microbial variables. Log10 transformation helps normalize highly skewed microbial count data and improves visual interpretability.This step also mirrors tidyverse workflows from Weeks 3 and 6.

#REVIEW CJT: Confused with the reference to Week 9 Spatial Data. We used spatial data to use the terra package to be able to plot maps. This looks to just be a graph with the latitudes and longitudes

water_clean <- water_clean |>
  dplyr::mutate(
    log_coliform = log10(coliform_mpn_100mL + 1),
    log_ecoli    = log10(e_coli_mpn_100mL + 1)
  )

# Convert the cleaned tibble into a base data frame, then into a terra SpatVector.
water_df <- as.data.frame(water_clean)

water_spat <- vect(
  water_df,
  geom = c("longitude", "latitude"),
  crs  = "EPSG:4326"   # WGS84 GPS coordinates
)

# I downloaded Tanzaniaâ€™s administrative boundaries (Level 1 = regions/districts) from the GADM database. This provides the polygon layer for spatial context.
tza <- gadm(country = "TZA", level = 1, path = "data_raw")

# Extract the geographic extent (bounding box) of your sample points.
dar_ext <- ext(water_spat)
dar_ext <- extend(dar_ext, 0.2)

# Crop the Tanzania boundary file to only keep the Dar es Salaam area.
tza_dar   <- crop(tza, dar_ext)
water_dar <- water_spat[tza_dar, ]

#This prevents errors when saving the PNG map files.
if (!dir.exists("outputs")) dir.create("outputs")

# Total coliform map

cols_coliform <- colorRampPalette(
  c("#FFFFCC", "#FFEE55", "#FFD700", "#FFB800", "#FFA500")
)(30)

# Save total coliform terra map (open device BEFORE plotting)
png("outputs/coliform_map_dar.png", width = 1800, height = 1400, res = 200)

plot(tza_dar, col = "gray90",
     main = "Total Coliform Contamination in Dar es Salaam (Yellow Scale)")

points(
  water_dar,
  col = cols_coliform[cut(water_dar$log_coliform, 30, include.lowest = TRUE)],
  pch = 20,
  cex = 1.3
)

legend(
  "bottomleft",
  legend = c("Low", "Medium", "High"),
  col    = cols_coliform[c(1, 15, 30)],
  pch    = 20,
  title  = "log10(Coliform)"
)

dev.off()  # close PNG device for coliform map


#Review CJT: Include a short line of what code you are using
# NOTE: This ggplot block is kept for reference, but turned off so only the two terra maps are produced.
if (FALSE) {

  p_ecoli_facet <- ggplot(water_clean,
                          aes(x = longitude, y = latitude, color = log_ecoli)) +
    geom_point(size = 3, alpha = 0.9) +
    scale_color_viridis_c(option = "magma") +
    coord_equal() +
    facet_wrap(~ districts) +
    labs(
      title = "E. coli Contamination Across Districts",
      x = "Longitude",
      y = "Latitude",
      color = "log10(E. coli)"
    ) +
    theme_minimal()

  #REVIEW CJT: I don't think you need to seperate longitude by 0.05, seems like a lot of text on the x-axis
  p_ecoli_facet

  #Review CJT: Include a short line of what code you are using
  ggsave(
    "outputs/ecoli_geospatial_facet_districts.png",
    plot = p_ecoli_facet,
    width = 8, height = 5, dpi = 300
  )

  #Review CJT: Include a short line of what code you are using

  p_coliform_facet <- ggplot(water_clean,
                             aes(x = longitude, y = latitude, color = log_coliform)) +
    geom_point(size = 3, alpha = 0.9) +
    scale_color_viridis_c(option = "plasma") +
    coord_equal() +
    facet_wrap(~ districts) +
    labs(
      title = "Total Coliform Contamination Across Districts",
      x = "Longitude",
      y = "Latitude",
      color = "log10(Coliform MPN/100 mL)"
    ) +
    theme_minimal()

  #REVIEW CJT: code color at high of log10() is too bright. Maybe use a darker color scheme
  p_coliform_facet

  #Review CJT: Include a short line of what code you are using
  ggsave(
    "outputs/coliform_geospatial_facet_districts.png",
    plot = p_coliform_facet,
    width = 8, height = 5, dpi = 300
  )
}


# E.coli map

cols_ecoli <- colorRampPalette(
  c("#FFCCCC", "#FF6666", "#FF0000", "#CC0000", "#800000")
)(30)

# Save E. coli terra map (open device BEFORE plotting)
png("outputs/ecoli_map_dar.png", width = 1800, height = 1400, res = 200)

plot(tza_dar, col = "gray90",
     main = "E. coli Contamination in Dar es Salaam (Red Scale)")

points(
  water_dar,
  col = cols_ecoli[cut(water_dar$log_ecoli, 30, include.lowest = TRUE)],
  pch = 20,
  cex = 1.3
)

legend(
  "bottomleft",
  legend = c("Low", "Medium", "High"),
  col    = cols_ecoli[c(1, 15, 30)],
  pch    = 20,
  title  = "log10(E. coli)"
)

dev.off()


# Display the coliform map in RStudio Plots pane (after saving)
plot(tza_dar, col = "gray90",
     main = "Total Coliform Contamination in Dar es Salaam (Yellow Scale)")
points(
  water_dar,
  col = cols_coliform[cut(water_dar$log_coliform, 30, include.lowest = TRUE)],
  pch = 20,
  cex = 1.3
)
legend(
  "bottomleft",
  legend = c("Low", "Medium", "High"),
  col    = cols_coliform[c(1, 15, 30)],
  pch    = 20,
  title  = "log10(Coliform)"
)

# Display the E. coli map in RStudio Plots pane (after saving)
plot(tza_dar, col = "gray90",
     main = "E. coli Contamination in Dar es Salaam (Red Scale)")
points(
  water_dar,
  col = cols_ecoli[cut(water_dar$log_ecoli, 30, include.lowest = TRUE)],
  pch = 20,
  cex = 1.3
)
legend(
  "bottomleft",
  legend = c("Low", "Medium", "High"),
  col    = cols_ecoli[c(1, 15, 30)],
  pch    = 20,
  title  = "log10(E. coli)"
)

```

```{r}
# Risk Classification Functions for Microbial Counts- Week 3 (tidyverse basics), and Week 5 (data visualization)
# Units: MPN/100 mL
# Rationale: Based on typical water quality thresholds.

# Function to classify E. coli levels into risk categories.

classify_ecoli_risk <- function(ecoli_value) {
  if (ecoli_value == 0) {
    "Safe"
  } else if (ecoli_value <= 10) {
    "Low Risk"
  } else if (ecoli_value <= 100) {
    "Intermediate Risk"
  } else {
    "High Risk"
  }
}

# Function to classify Total Coliform levels into risk categories.

classify_coliform_risk <- function(coliform_value) {
  if (coliform_value == 0) {
    "Safe"
  } else if (coliform_value <= 10) {
    "Low Risk"
  } else if (coliform_value <= 100) {
    "Intermediate Risk"
  } else {
    "High Risk"
  }
}

# Applying the function
water_clean <- water_raw |>
  mutate(
    ecoli_risk_level    = sapply(e_coli_mpn_100mL, classify_ecoli_risk),
    coliform_risk_level = sapply(coliform_mpn_100mL, classify_coliform_risk)
  )

# Summary table of E. coli risk levels by district

risk_by_district <- water_clean |>
  group_by(districts, ecoli_risk_level) |>
  summarise(n = n(), .groups = "drop") |>
  #Review CJT: you probably don't need to add the tidyr function
  tidyr::pivot_wider(
    names_from = ecoli_risk_level,
    values_from = n,
    values_fill = 0
  )

risk_by_district   

# Bar plot ofColiform risk levels by district 

p_coliform_risk <- ggplot(water_clean, aes(x = districts, fill = coliform_risk_level)) +
  geom_bar(position = "fill") +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(
    title = "Coliform Risk Levels Across Districts",
    x = "District",
    y = "Percentage of Samples",
    fill = "Coliform Risk Level"
  ) +
  theme_minimal()

p_coliform_risk

ggsave(
  "outputs/coliform_risk_by_district.png",
  plot = p_coliform_risk,
  width = 8, height = 5, dpi = 300
)

# Bar plot of E.coli risk levels by district 

p_ecoli_risk <- ggplot(water_clean, aes(x = districts, fill = ecoli_risk_level)) +
  geom_bar(position = "fill") +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(
    title = "E. coli Risk Levels Across Districts",
    x = "District",
    y = "Percentage of Samples",
    fill = "E. coli Risk Level"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

p_ecoli_risk

ggsave(
  "outputs/ecoli_risk_by_district.png",
  plot = p_ecoli_risk,
  width = 8, height = 5, dpi = 300
)

```

```         
```

```{r}
#I use a for loop Week 13 (iteration and loops) to iterate over districts, calculate mean coliform and E. coli concentrations, and store the results in a structured data frame.

# WHO Risk Lookup Table (Week 4: Joins & Lookup Tables)
districts <- unique(water_clean$districts)
loop_results <- data.frame(district = character(), mean_coliform = numeric())

for (d in districts) {
  mean_val <- mean(water_clean$coliform_mpn_100mL[water_clean$districts == d])
  loop_results <- rbind(loop_results, data.frame(district = d, mean_coliform  = mean_val))
}

loop_results

 # Mean E. coli for each district using a loop.
districts <- unique(water_clean$districts)
loop_results <- data.frame(district = character(), mean_ecoli = numeric())

for (d in districts) {
  mean_val <- mean(water_clean$e_coli_mpn_100mL[water_clean$districts == d])
  loop_results <- rbind(loop_results, data.frame(district = d, mean_ecoli = mean_val))
}

loop_results
```

```{r}

# WHO Risk Lookup Table (Week 4: Joins & Lookup Tables)


# Created a lookup table that links each categorical risk level to WHO-style microbiological risk categories and recommended actions.

who_risk_info <- tribble(
  ~risk_level,          ~who_category,                ~action_recommendation,
  "Safe",               "Meets WHO guideline",        "No immediate action required",
  "Low Risk",           "Low microbiological risk",   "Encourage safe storage and hygiene",
  "Intermediate Risk",  "Moderate microbiological risk", "Investigate source and consider treatment",
  "High Risk",          "High microbiological risk",  "Urgent: treat water or use alternative source"
)

# Summarize E. coli risk levels by district, counting samples and computing the percentage of samples in each risk category.

ecoli_by_district <- water_clean |>
  count(districts, ecoli_risk_level, name = "n") |>
  group_by(districts) |>
  mutate(pct = n / sum(n)) |>
  ungroup()

# Joining the E. coli district risk summary with the WHO lookup table to add WHO category and recommended action for each risk level
ecoli_risk_with_who <- ecoli_by_district |>
  rename(risk_level = ecoli_risk_level) |>
  left_join(who_risk_info, by = "risk_level")

ecoli_risk_with_who


coliform_by_district <- water_clean |>
  count(districts, coliform_risk_level, name = "n") |>
  group_by(districts) |>
  mutate(pct = n / sum(n)) |>
  ungroup()

#Joining the coliform district risk summary with the WHO lookup table to add WHO category and recommended action for each risk level
coliform_risk_with_who <- coliform_by_district |>
  rename(risk_level = coliform_risk_level) |>
  left_join(who_risk_info, by = "risk_level")

coliform_risk_with_who

```
